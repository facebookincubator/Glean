<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-schema/changing">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">How do I change a schema? | Glean</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://glean.software/docs/schema/changing/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="How do I change a schema? | Glean"><meta data-rh="true" name="description" content="Glean supports modifying the schema directly, while providing"><meta data-rh="true" property="og:description" content="Glean supports modifying the schema directly, while providing"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://glean.software/docs/schema/changing/"><link data-rh="true" rel="alternate" href="https://glean.software/docs/schema/changing/" hreflang="en"><link data-rh="true" rel="alternate" href="https://glean.software/docs/schema/changing/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Glean RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Glean Atom Feed"><link rel="stylesheet" href="/assets/css/styles.a464e807.css">
<link rel="preload" href="/assets/js/runtime~main.2d7eea37.js" as="script">
<link rel="preload" href="/assets/js/main.0f46e81b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="content_knG7 announcementBarContent_xLdY">Support Ukraine üá∫üá¶ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Glean</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/introduction/">Documentation</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/glean" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/introduction/">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/schema/basic/">User Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/schema/basic/">Schemas</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/schema/basic/">Basic Concepts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/schema/types/">Built-in Types</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/schema/syntax/">Syntax</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/schema/recursion/">Recursion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/schema/changing/">Changing a schema</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/schema/all/">The special &quot;all&quot; schema</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/schema/workflow/">Workflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/schema/thrift/">Thrift and JSON</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/schema/design/">Design</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/query/intro/">Querying</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/derived/">Derived Predicates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/databases/">Glean Databases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/write/">Writing data to Glean</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/running/">Running the Tools</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/shell/">Using the Shell</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/server/">Running the Glean Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cli/">The Glean CLI tool</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/indexer/intro/">Indexers</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/implementation/incrementality/">Developers</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">User Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Schemas</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Changing a schema</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>How do I change a schema?</h1></header><p>Glean supports modifying the schema directly, while providing
backwards compatibility between existing clients and data across the
schema change.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="basic-rules">Basic rules<a class="hash-link" href="#basic-rules" title="Direct link to heading">‚Äã</a></h3><p>To preserve compatibility between clients and data, the schema can
only be changed in <strong>compatible</strong> ways. This means:</p><ul><li>Adding or removing a field from a record, if the field has a <strong>defaultable</strong> type (see <a href="#default-values">Default values</a>)</li><li>Adding or removing an alternative from a sum type</li><li>Adding or removing a predicate or type declaration</li></ul><p>An example of an <em>incompatible</em> change would be changing the type of a
field, for example from <code>nat</code> to <code>bool</code>.</p><p>Of course it&#x27;s fine to make arbitrary changes to a schema that you&#x27;re
working on; the compatibility rules only come into effect when you
have existing databases and want to preserve compability with clients
during the schema change.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compatibility">Compatibility<a class="hash-link" href="#compatibility" title="Direct link to heading">‚Äã</a></h3><p>When the schema is changed, Glean supports any combination of old or
new clients (that is, clients built against the old or new version of
the schema) with old or new data.</p><ul><li>If the client requests a field that doesn&#x27;t exist in the data, the field will be filled with its default value.</li><li>If a query matches on an alternative that doesn&#x27;t exist in the schema, the match will fail.</li><li>If the data contains an alternative that doesn&#x27;t exist in the client&#x27;s schema, then the client will receive an <code>unknown</code> value (this is represented as an <code>EMPTY</code> constructor in the Thrift-generated datatypes).</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="default-values">Default values<a class="hash-link" href="#default-values" title="Direct link to heading">‚Äã</a></h3><p>A <strong>defaultable</strong> type is any type that is not a predicate. So for
example, if <code>P</code> is a predicate type, then we could add a field <code>f :
maybe P</code> but not a field <code>f : P</code>. The reason for this restriction is
that Glean must be able to substitute a default value for the
field when a client is using the new schema but the data is using the
old schema, and there cannot be a default value for a predicate.</p><p>Default values for missing fields are determined according to the
following table:</p><table><thead><tr><th>Type</th><th>Default value</th></tr></thead><tbody><tr><td><code>nat</code></td><td><code>0</code></td></tr><tr><td><code>byte</code></td><td><code>0</code></td></tr><tr><td><code>string</code></td><td><code>&quot;&quot;</code></td></tr><tr><td><code>[T]</code></td><td><code>[]</code></td></tr><tr><td><code>{ field‚ÇÅ : T‚ÇÅ, ..., field‚Çô : T‚Çô }</code></td><td><code>{ field‚ÇÅ = default(T‚ÇÅ), ..., field‚Çô = default(T‚Çô) }</code></td></tr><tr><td><code>{ field‚ÇÅ : T‚ÇÅ <!-- -->|<!-- --> ... <!-- -->|<!-- --> field‚Çô : T‚Çô }</code></td><td><code>{ field‚ÇÅ = default(T‚ÇÅ) }</code></td></tr><tr><td><code>bool</code></td><td><code>false</code></td></tr><tr><td><code>maybe T</code></td><td><code>nothing</code></td></tr><tr><td><code>enum { name‚ÇÅ <!-- -->|<!-- --> ... <!-- -->|<!-- --> name‚Çô }</code></td><td><code>name‚ÇÅ</code></td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-if-my-schema-changes-are-incompatible">What if my schema changes are incompatible?<a class="hash-link" href="#what-if-my-schema-changes-are-incompatible" title="Direct link to heading">‚Äã</a></h3><p>You can add new predicates representing the new data. Then you have
the option of</p><ol><li>Writing both the old and the new data to the database</li><li>Producing two databases, one with the old data and one with the new data. The databases can be distinguished by different names or different properties.</li></ol><p>With approach (1), you can migrate clients incrementally and then eventually
stop producing the old data. But the downside of this approach is that
the database may contain a lot more data than necessary; writing may
take a lot longer, and so on.</p><p>With approach (2), you first have to ensure clients select the old
database. Then as you migrate clients, change them to use the new data
and select the new database at the same time.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-does-it-work">How does it work?<a class="hash-link" href="#how-does-it-work" title="Direct link to heading">‚Äã</a></h3><p>A particular instance of the schema is identified by a
<code>SchemaId</code>. This is a hash value computed from the full contents of
the schema. The <code>SchemaId</code> of the current schema is available through
the <code>schema_id</code> value exported by the <code>builtin</code> schema (the
<code>Glean.Schema.Builtin.Types</code> module in Haskell).</p><p>The server keeps track of multiple instances of the schema in a
<strong>schema index</strong>. Each instance of the schema is identified by its
<code>SchemaId</code>. Each database also contains the schema that it was written
with. The schema index is manipulated using the <code>gen-schema</code> tool in
the Glean repository; to use a particular index we can use <code>--schema
indexfile:FILE</code> or <code>--schema indexconfig:CONFIG</code>.</p><p>A client sends its <code>SchemaId</code> to the server in the <code>schema_id</code> field
of the query. For Haskell clients this is done automatically: the
client passes its <code>SchemaId</code> when initialising the Glean client
library, and this <code>SchemaId</code> is passed on to the server for every
query.</p><p>The server knows which schema the client is using, so it can translate
the data in the database into the client&#x27;s schema automatically.</p><p>When a database is created, the schema used by the database is chosen
by the <code>glean.schema_id</code> property set by the client creating the
database. Again for Haskell clients this happens automatically.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="evolving-schemas">Evolving schemas<a class="hash-link" href="#evolving-schemas" title="Direct link to heading">‚Äã</a></h3><p>Glean also allows backwards-compatibility between co-existing schemas,
which can be useful if you want to perform schema changes in a more
explicit way, or to rename schemas.</p><p>The feature is enabled using a top-level directive</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema my_schema.2 evolves my_schema.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This declaration has the effect of treating queries for <code>my_schema.1</code> predicates as if they were for <code>my_schema.2</code>. That is the query results will be retrieved from the database in the shape of a <code>my_schema.2</code> fact and transformed into a fact of the equivalent <code>my_schema.1</code> predicate specified in the query.</p><p>The new schema must contain all the predicates of the old schema, either with new versions or old versions, and their definitions must be backwards compatible. We can achieve this by copying the entire content of the old schema into the new one and modifying it there.</p><p>Now what should Glean do when a client asks for a fact from an old schema?</p><ul><li>Answer with db facts from the old schema</li><li>Answer with db facts from the new schema transformed into the old ones.</li></ul><p>If there are no facts of the old schema in in the database we will take option 2.
If the database has any fact at all of the old schema we choose option 1.</p><p>That is, schema evolutions only take effect if there are no facts of the old schema in the database; it is ignored otherwise.</p><p>As an example suppose we start with the following schemas:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema src.1 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   predicate File {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     path : string</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema os.1 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  import src.1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  predicate Permissions {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    file : File,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    permissions : nat</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema info.1 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  import src.1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  predicate IsTemporary {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    file : File</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  } F where F = src.File { path = &quot;/tmp&quot;.. }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we want to make a backward-compatible change to <code>src.File</code> and add an <code>extension</code> field. We could add this to the file:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema src.2 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   predicate File {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     path : string,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     extension : string</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema src.2 evolves src.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now if the indexer is still producing only <code>src.1</code> facts, all other predicates will work as before and queries for <code>src.File.2</code> will return no results.</p><p>Once the indexer is changed to produce only <code>src.2</code> facts queries like <code>src.File.1 _</code> will be fulfilled using data from the <code>src.2</code> schema, converting the <code>src.File.2</code> results to the shape of <code>src.File.1</code> before returning to the client.</p><p>This is also the case in the derivation query of <code>info.IsTemporary</code>. Although <code>info</code> imports <code>src.1</code>, the query will be transformed to use <code>src.2</code> facts.</p><p>On the other hand, <code>os.Permissions</code> will be empty. This must be the case because its first field references a <code>src.File.1</code> fact, of which there is none in the database. For this predicate to continue being available we must evolve its schema as well.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema os.2 {             # changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  import src.2            # changed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  predicate Permissions {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    file : File,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    permissions : nat</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema os.2 evolves os.1    # changed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebookincubator/Glean/tree/main/glean/website/docs/schema/changing.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/schema/recursion/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Recursion</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/schema/all/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">The special &quot;all&quot; schema</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#basic-rules" class="table-of-contents__link toc-highlight">Basic rules</a></li><li><a href="#compatibility" class="table-of-contents__link toc-highlight">Compatibility</a></li><li><a href="#default-values" class="table-of-contents__link toc-highlight">Default values</a></li><li><a href="#what-if-my-schema-changes-are-incompatible" class="table-of-contents__link toc-highlight">What if my schema changes are incompatible?</a></li><li><a href="#how-does-it-work" class="table-of-contents__link toc-highlight">How does it work?</a></li><li><a href="#evolving-schemas" class="table-of-contents__link toc-highlight">Evolving schemas</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/glean" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright ¬© 2023 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2d7eea37.js"></script>
<script src="/assets/js/main.0f46e81b.js"></script>
</body>
</html>