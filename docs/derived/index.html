<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Glean Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Glean Blog Atom Feed"><title data-react-helmet="true">Derived Predicates | Glean</title><meta data-react-helmet="true" property="og:url" content="https://glean.software/docs/derived"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Derived Predicates | Glean"><meta data-react-helmet="true" name="description" content="Glean supports predicates that are defined in terms of a query. There are two types of derived predicates, &quot;stored&quot; and &quot;on demand&quot;."><meta data-react-helmet="true" property="og:description" content="Glean supports predicates that are defined in terms of a query. There are two types of derived predicates, &quot;stored&quot; and &quot;on demand&quot;."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://glean.software/docs/derived"><link data-react-helmet="true" rel="alternate" href="https://glean.software/docs/derived" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://glean.software/docs/derived" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.31d7bcf4.css">
<link rel="preload" href="/assets/js/runtime~main.cf0f57f0.js" as="script">
<link rel="preload" href="/assets/js/main.9d18e438.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title">Glean</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/introduction">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/glean" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><b class="navbar__title">Glean</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/introduction">Documentation</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/glean" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Quick Start</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/trying">Trying Glean</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/building">Building Glean</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/walkthrough">Walkthrough</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">User Guide</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Schemas</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/schema/basic">Basic Concepts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/schema/types">Built-in Types</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/schema/syntax">Syntax</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/schema/recursion">Recursion</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/schema/changing">Changing a schema</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/schema/workflow">Workflow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/schema/thrift">Thrift and JSON</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Querying</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/query/intro">Overview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">Angle</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/angle/intro">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/angle/guide">Guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/angle/efficiency">Query Efficiency</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/angle/advanced">Advanced Query Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/angle/debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/angle/reference">Reference</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/angle/style">Style Guide</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">APIs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/query/api/haskell">Haskell</a></li></ul></li></ul></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/derived">Derived Predicates</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/databases">Glean Databases</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/write">Writing data to Glean</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/running">Running the Tools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/shell">Using the Shell</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/server">Running the Glean Server</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cli">The Glean CLI tool</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Indexers</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/indexer/intro">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/indexer/flow">Javascript (Flow)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/indexer/hack">Hack</a></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_1lV3"><div class="docItemContainer_zt2Y"><article><header><h1 class="docTitle_1y8q">Derived Predicates</h1></header><div class="markdown"><p>Glean supports predicates that are defined in terms of a query. There are two types of derived predicates, &quot;stored&quot; and &quot;on demand&quot;.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="stored-derived-predicates"></a>Stored derived predicates<a class="hash-link" href="#stored-derived-predicates" title="Direct link to heading">#</a></h2><p>For example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=angle"><pre tabindex="0" class="prism-code language-lang=angle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">predicate OutTarget.1 :</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        file : src.File,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        target : Target,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    stored {F,T} where TargetOut {T,F}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is a schema for a predicate <code>OutTarget</code> with a key type as usual. But unlike a regular predicate, facts of this predicate are not generated by an indexer, instead they are generated by the query given on the final line.</p><p>The keyword <code>stored</code> tells Glean that the facts for this predicate will be stored in the database. Omitting the <code>stored</code> keyword indicates that you want the facts to be generated on demand; more about this in <a href="#on-demand-derived-predicates">On-demand derived predicates</a> below.</p><p>You can read the query as</p><blockquote><p>There is a fact OutTarget {F,T} for every fact TargetOut {T,F}</p></blockquote><p>The query can be any arbitrary Angle query; the syntax is described in
<a href="/docs/angle/guide">Angle Guide</a>. The only requirement is that the values
produced by the query must match the key type of the predicate being
defined.</p><p>Why is this useful?  Well, the predicate <code>TargetOut</code> is defined like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=angle"><pre tabindex="0" class="prism-code language-lang=angle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">predicate TargetOut.1 :</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        target : Target,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        file : src.File,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is a mapping from <code>Target</code> to <code>File</code> (see <a href="/docs/angle/efficiency#efficient-matching-of-facts">Efficient matching of facts</a>).  If we want the reverse mapping, from <code>File</code> to <code>Target</code>, we need a predicate with the fields in the other order, which is exactly what <code>OutTarget</code> is. But it would be laborious to write actual code to generate and store these facts in the database, so Glean allows us to define <code>OutTarget</code> directly in terms of a query, and it will automatically compute the facts of <code>OutTarget</code> and store them in the database.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="when-do-the-facts-get-computed-and-stored"></a>When do the facts get computed and stored?<a class="hash-link" href="#when-do-the-facts-get-computed-and-stored" title="Direct link to heading">#</a></h3><p>Using the <code>glean</code> command-line tool, you direct the server to compute and store the facts for a predicate like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=shell"><pre tabindex="0" class="prism-code language-lang=shell codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">glean derive --service &lt;write-server&gt; buck.TargetOut</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Replacing <code>&lt;write-server&gt;</code> with the appropriate name of the write
service you&#x27;re using, and replace <code>buck.TargetOut</code> with the name of
the predicate you want to derive.</p><p>This may take some time, depending on how many facts need to be computed and stored.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Remember to do this <em>before</em> using <code>glean finish</code> to mark the database
as finished.</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="deriving-multiple-predicates"></a>Deriving multiple predicates<a class="hash-link" href="#deriving-multiple-predicates" title="Direct link to heading">#</a></h3><p>You can derive multiple predicates together:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=shell"><pre tabindex="0" class="prism-code language-lang=shell codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">glean derive --service &lt;write-server&gt; &lt;predicate&gt; &lt;predicate&gt; ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>But note that these predicates must be independent; they cannot depend
on each other. If you have derived predicates that depend on each
other, you have to issue separate <code>glean derive</code> commands to derive
the predicates in bottom-up dependency order.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="on-demand-derived-predicates"></a>On-demand derived predicates<a class="hash-link" href="#on-demand-derived-predicates" title="Direct link to heading">#</a></h2><p>The other type of derived predicate is one where the facts are not stored in the database, but are computed on-demand when there is a query for the predicate.</p><p>This is useful for a few reasons:</p><ul><li>We can support <a href="#derived-predicates-for-schema-migration">backwards compatibility</a> by defining old predicates in terms of new ones, or forwards compatibility by doing the reverse.</li><li>We can define queries that extract data and bundle it in a way that&#x27;s convenient and efficient for the client. This allows clients to avoid fetching more data than they need, for example.</li><li>Most importantly, we can encapsulate complex queries by defining them in the schema as derived predicates, even building up libraries representing whole abstraction layers over the raw data. Clients can then use the higher-level abstraction regardless of where they&#x27;re querying from or what language they&#x27;re using. For a great example of using this in practice, see the <a href="https://github.com/facebookincubator/Glean/blob/master/glean/schema/source/codemarkup.angle" target="_blank" rel="noopener noreferrer">codemarkup schema</a> that we use to provide a language-neutral abstraction over language-specific schemas.</li></ul><p>For example, in the <code>cxx</code> schema we have a lot of different kinds of declarations. Clients often want to search for a declaration by name, but each of the different declaration kinds has the name in a different place, so this ends up being quite a complicated query from the client side. Using a derived predicate we can easily capture this complexity in one place so that it can be reused by all clients that want to search for declarations by name:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=angle"><pre tabindex="0" class="prism-code language-lang=angle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">predicate DeclarationWithName :</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name : string,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        decl : Declaration</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {Str, Decl} where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      N = Name Str;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      Decl =</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        (Declaration (record_ R) where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          R = RecordDeclaration { name = { name = N }}) |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        (Declaration (function_ F) where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          F = FunctionDeclaration { name = { name = { name = N }}}) |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        # and so on, for all declaration types</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Using this predicate requires no magic on the part of the client, they just query for the <code>cxx1.DeclarationWithName</code> predicate in exactly the same way as they would for other predicates, and the Glean query server returns the appropriate facts.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="derived-predicates-for-schema-migration"></a>Derived predicates for schema migration<a class="hash-link" href="#derived-predicates-for-schema-migration" title="Direct link to heading">#</a></h2><p>One important use case for derived predicates is to make it possible to change the schema without breaking things.</p><p>Essentially the idea is that a derived predicate can define the old predicate in terms of the new predicate, providing backwards-compatibility to clients that are expecting to query for the old predicate. Additionally, we might define the new predicate in terms of the old predicate, for forwards-compatibility to allow new clients to work with old data.</p><p>Let&#x27;s work through an example to illustrate the process.  Suppose your schema is like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=angle"><pre tabindex="0" class="prism-code language-lang=angle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema lang.1 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">predicate Declaration :</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         name : string,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         source : src.Range,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>now suppose we want to add documentation to the declarations that we indexed. We define a new version of the schema, <code>lang.2</code>, with a new <code>Declaration</code> predicate:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=angle"><pre tabindex="0" class="prism-code language-lang=angle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema lang.2 : lang.1 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">predicate Declaration :</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name : string,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source : src.Range,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        doc : string</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now, we proceed to make our changes:</p><ol><li>Update the schema</li><li>Modify the indexer to generate facts of the new predicate <code>lang.Declaration.2</code></li></ol><p>At this point, any DBs generated by the new indexer will have <code>lang.Declaration.2</code> facts, and not <code>lang.Declaration.1</code>. Existing clients that query for the old facts will get no results. We can probably recompile those clients to pick up the new <code>lang.Declaration.2</code> facts, but that would be a tricky migration: the new client won&#x27;t work on the old DBs, and the old client won&#x27;t work on the new DBs.</p><p>To make this migration smoother, we can add a derived predicate:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=angle"><pre tabindex="0" class="prism-code language-lang=angle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">schema lang.2 : lang.1 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">predicate Declaration :</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name : string,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source : src.Range,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        doc : string</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> derive lang.Declaration.1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { name = N, source = S } where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        lang.Declaration.2 { name = N, source = S }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>the <code>derive lang.Declaration.1</code> declaration is just like adding an on-demand derived predicate to <code>predicate Declaration</code> in the <code>lang.1</code> schema, but we have to declare it as part of the <code>lang.2</code> schema because it needs to refer to <code>lang.Declaration.2</code>.</p><p>This derived predicate takes effect as follows:</p><ul><li>It <strong>does not apply to old DBs</strong> that contain <code>lang.Declaration.1</code> but not <code>lang.Declaration.2</code>.</li><li>It <strong>does apply to new DBs</strong> created with the new <code>lang.Declaration.2</code> schema. So after the schema change, we can only create facts of <code>lang.Declaration.2</code>, not the old predicate.</li></ul><p>So clients that query for <code>lang.Declaration.1</code> will continue to work both with old DBs containing <code>lang.Declaration.1</code> <em>and</em> new DBs that contain <code>lang.Declaration.2</code>, and we can migrate them to use the new schema at our leisure.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="default-derived-predicates"></a>Default derived predicates<a class="hash-link" href="#default-derived-predicates" title="Direct link to heading">#</a></h3><p>There&#x27;s one extra feature that can be used to make the schema migration even smoother.</p><p>Recall with the <code>derive</code> declaration in the previous section we had to synchronise the update of the schema with the rollout of the new version of the indexer to generate the new facts? It&#x27;s possible to decouple those by making one tweak:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=angle"><pre tabindex="0" class="prism-code language-lang=angle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"> derive lang.Declaration.1 default</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # ... same as before</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The addition of the <code>default</code> keyword to the declaration has the following effect:</p><ul><li>A <code>default</code> derived predicate only takes effect when the DB is complete (i.e. read-only) and <strong>contains no facts</strong> of the predicate.</li></ul><p>This allows us to update the schema but still generate facts of the old predicate. The derived predicate will only kick in when we update the indexer to generate the new facts.</p><p>What&#x27;s more, we can use this technique to provide <strong>forwards compatibility</strong> too:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=angle"><pre tabindex="0" class="prism-code language-lang=angle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"> derive lang.Declaration.2 default</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { name = N, source = S, doc = &quot;&quot; } where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        lang.Declaration.1 { name = N, source = S }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Since this is a <code>default</code> derivation, it will take effect when there are no facts of the new predicate. So we can update clients to work with the new version of the predicate, and they will continue to work on old DBs - albeit with empty strings for the new <code>doc</code> field, because the old DBs don&#x27;t contain that data.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-do-i-write-and-test-a-derived-predicate"></a>How do I write and test a derived predicate?<a class="hash-link" href="#how-do-i-write-and-test-a-derived-predicate" title="Direct link to heading">#</a></h2><p>There&#x27;s a process for iterating and testing derived predicates using the shell with a local database. Follow these steps:</p><p>Obtain the DB you want to test with, let&#x27;s assume you put it in
<code>~/local/gleandb</code>.</p><p>Start the shell with the local DB and schema:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=shell"><pre tabindex="0" class="prism-code language-lang=shell codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">glean shell --db-root ~/local/gleandb --schema glean/schema/source</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Add <code>--db-schema-override</code> if you are working on an existing predicate and want your version to override the schema in the DB.</p><p>Select your DB with the <code>:db</code> command.</p><p>Make edits to the local schema source files in <code>glean/schema/source</code>. There&#x27;s no need to run <code>glean/schema/sync</code>, you can pick up the changes immediately in the shell:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lang=shell"><pre tabindex="0" class="prism-code language-lang=shell codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">:reload</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Test your derived predicate using queries in the shell, use <code>:reload</code> to pick up new changes, and repeat as necessary.</p><p>The <code>:timeout</code> command can be used to change the default query timeout while iterating.</p><p>If you run into performance issues, try the techniques in <a href="/docs/angle/debugging">Debugging
Queries</a>.</p><p>When you&#x27;re done, the next section describes how to get your derived predicate into the schema proper.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-do-i-make-a-derived-predicate-available"></a>How do I make a derived predicate available?<a class="hash-link" href="#how-do-i-make-a-derived-predicate-available" title="Direct link to heading">#</a></h2><p>Derived predicates are defined directly in the schema, so the process
for adding them is exactly the same as modifying the schema, described
over in <a href="/docs/schema/workflow">Schema Workflow</a>.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebookincubator/Glean/tree/main/glean/website/docs/derived.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/query/api/haskell"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Haskell</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/databases"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Glean Databases Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#stored-derived-predicates" class="table-of-contents__link">Stored derived predicates</a><ul><li><a href="#when-do-the-facts-get-computed-and-stored" class="table-of-contents__link">When do the facts get computed and stored?</a></li><li><a href="#deriving-multiple-predicates" class="table-of-contents__link">Deriving multiple predicates</a></li></ul></li><li><a href="#on-demand-derived-predicates" class="table-of-contents__link">On-demand derived predicates</a></li><li><a href="#derived-predicates-for-schema-migration" class="table-of-contents__link">Derived predicates for schema migration</a><ul><li><a href="#default-derived-predicates" class="table-of-contents__link">Default derived predicates</a></li></ul></li><li><a href="#how-do-i-write-and-test-a-derived-predicate" class="table-of-contents__link">How do I write and test a derived predicate?</a></li><li><a href="#how-do-i-make-a-derived-predicate-available" class="table-of-contents__link">How do I make a derived predicate available?</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/glean" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.cf0f57f0.js"></script>
<script src="/assets/js/main.9d18e438.js"></script>
</body>
</html>