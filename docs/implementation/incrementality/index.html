<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-implementation/incrementality">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Incrementality | Glean</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://glean.software/docs/implementation/incrementality/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Incrementality | Glean"><meta data-rh="true" name="description" content="This is a walkthrough of the most important parts of the"><meta data-rh="true" property="og:description" content="This is a walkthrough of the most important parts of the"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://glean.software/docs/implementation/incrementality/"><link data-rh="true" rel="alternate" href="https://glean.software/docs/implementation/incrementality/" hreflang="en"><link data-rh="true" rel="alternate" href="https://glean.software/docs/implementation/incrementality/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Glean RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Glean Atom Feed"><link rel="stylesheet" href="/assets/css/styles.a464e807.css">
<link rel="preload" href="/assets/js/runtime~main.2d7eea37.js" as="script">
<link rel="preload" href="/assets/js/main.0f46e81b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="content_knG7 announcementBarContent_xLdY">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Glean</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/introduction/">Documentation</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/glean" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/introduction/">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/schema/basic/">User Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/implementation/incrementality/">Developers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/implementation/incrementality/">Implementation Notes</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/implementation/incrementality/">Incrementality</a></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developers</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Implementation Notes</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Incrementality</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Incrementality</h1></header><p>This is a walkthrough of the most important parts of the
implementation of incrementality, aimed at people working on Glean.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="units">Units<a class="hash-link" href="#units" title="Direct link to heading">â€‹</a></h2><p>A <em>unit</em> is an arbitrary string. In Thrift:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">typedef string (hs.type = &quot;ByteString&quot;) UnitName</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Units do not need to be declared beforehand; a Unit exists if it is
the owner of at least one fact.</p><p>Each unit is assigned a unique integer, called <code>UnitId</code>. This is done
by the storage backend the first time the unit is encountered, and
thereafter the unit will be referred to by its <code>UnitId</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="capturing-ownership-data-from-the-indexer">Capturing ownership data from the indexer<a class="hash-link" href="#capturing-ownership-data-from-the-indexer" title="Direct link to heading">â€‹</a></h2><p>The indexer provides an initial mapping of facts to units (or units to
facts, if you like). A fact can have an arbitrary number of owners.
This is done in one of two ways.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="json">JSON<a class="hash-link" href="#json" title="Direct link to heading">â€‹</a></h3><p>For indexers that produce JSON, the unit is an optional field:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;predicate&quot;: &quot;glean.test.Node.5&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;facts&quot; : [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         &quot;key&quot;: { &quot;label&quot;: &quot;d&quot; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   ],</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;unit&quot;: &quot;D&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">},</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>unit</code> here is the owner of all the facts in the <code>facts</code> array.</p><p>For an example JSON file with units, see </p><div file="glean/shell/tests/owner.glean"></div>.<p></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="binary">Binary<a class="hash-link" href="#binary" title="Direct link to heading">â€‹</a></h3><p>Indexers that produce binary facts can annotate a batch of facts with owners:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct Batch {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  5: map&lt;UnitName, list&lt;Id&gt; (hs.type = &quot;VectorStorable&quot;)&gt; (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    hs.type = &quot;HashMap&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ) owned;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Specifies ownership of the facts in this batch. The list is really a
list of intervals <code>[x1,x2, y1,y2, ... ]</code> representing the inclusive
ranges <code>x1..x2</code>, <code>y1..y2</code>, ... where <code>x1 &lt;= x2</code>, <code>y1 &lt;= y2</code>, ...</p><p>The ranges do not need to be sorted, and can overlap.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storing-the-ownership-data">Storing the ownership data<a class="hash-link" href="#storing-the-ownership-data" title="Direct link to heading">â€‹</a></h3><p>The raw ownership data from the indexer is captured when the facts are
written to the DB. The fact IDs in the ownership data are substituted
with the final fact IDs of the facts.</p><p>Note that we might be writing a fact that already exists in the DB; in
that case we don&#x27;t write the fact, but we must still remember the
ownership mapping, because it might be adding additional owners.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ownership-sets">Ownership sets<a class="hash-link" href="#ownership-sets" title="Direct link to heading">â€‹</a></h2><p>In general the owner of a fact is an <em>ownership set</em>, which has the
following form:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  set ::= unit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        | set_1 || ... || set_n</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        | set_1 &amp;&amp; ... &amp;&amp; set_n</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That is, an ownership set is either a <em>unit</em>, or a disjunction of sets
(<code>set_1 || ... || set_n</code>), or a conjunction of sets (<code>set_1 &amp;&amp; ... &amp;&amp;
set_n</code>).</p><p>Each unique set is assigned a unique ID, called <code>UsetId</code> in the
implementation. <code>UsetId</code> and <code>UnitId</code> use distinct ranges, so we can
represent a set in a canonical way as an operator (<code>||</code> or <code>&amp;&amp;</code>)
together with an integer set. The implementation of this is
<code>SetExpr&lt;T&gt;</code> in </p><div file="glean/rts/ownership/uset.h"></div>.<p></p><p>A set may only refer to <code>UsetId</code>s that are smaller than its <code>UsetId</code>
(just like facts can only refer to smaller fact IDs).</p><p>The efficiency of this scheme depends on the assumption that while
there are a lot of facts, there are relatively few distinct ownership
sets. Typically we see between 10-100x more facts than sets. The
storage we need for sets is therefore small relative to the size of
the DB. This assumption rests on the indexer using a coarse enough
range of units; one unit per file or module is good, but one unit per
function would lead to more sets.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="visibility-and-slices">Visibility and slices<a class="hash-link" href="#visibility-and-slices" title="Direct link to heading">â€‹</a></h2><p>When building an incremental DB, we will <em>exclude</em> some units from the
base DB. This is done by building a <em>slice</em> (see </p><div file="glean/rts/ownership/slice.h"></div>)<p></p><ul><li>A <em>slice</em> is a set of <code>UsetId</code></li><li>A <code>UsetId</code> is in the slice if<ul><li><code>unit</code>: <code>unit</code> is not excluded</li><li><code>set_1 || ... || set_n</code>: any of <code>set_1 ... set_n</code> are in the slice</li><li><code>set_1 &amp;&amp; ... &amp;&amp; set_n</code>: all of <code>set_1 ... set_n</code> are in the slice</li></ul></li><li>A fact is visible if its <code>UsetId</code> is in the slice</li></ul><p>A slice is represented by a bitmap. To construct the slice we
determine the visibility of each <code>UsetId</code> in ascending order, so that
when we process a given set we already know the visibility of the sets
it refers to.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="propagating-ownership-to-dependent-facts">Propagating ownership to dependent facts<a class="hash-link" href="#propagating-ownership-to-dependent-facts" title="Direct link to heading">â€‹</a></h2><p>The property we want is that</p><blockquote><p>In a DB consisting of all the visible facts for a given set of
excluded units, every fact referenced by a visible fact is
also visible.</p></blockquote><p>(Basically, there are no dangling references.)</p><p>To achieve this, we have to make sure that the ownership sets are
built such that this property is true for any set of excluded units.</p><p>This is done as follows:</p><ul><li>for a fact F with ownership set A<ul><li>for each fact referenced by F with ownership set B<ul><li>we make the owner <code>A || B</code></li></ul></li></ul></li></ul><p>This is obviously correct: if F is visible, then every fact it refers
to will also be visible.</p><p>In practice we make this efficient by:</p><ul><li><p>Traverse facts in reverse order, so we always visit a fact before
the facts it depends on, and we only have to visit each fact once.</p></li><li><p>We only have disjunctions at this stage (conjunctions arise with
derived facts in the next stage), so we can normalise <code>A || B</code> by
taking the union of the sets <code>A</code> and <code>B</code>. We use an efficient
integer set representation with fast union (see </p><div file="glean/rts/ownership/setu32.h"></div>).<p></p></li></ul><p>This propagation requires <em>O(facts)</em> time, and the current
implementation also requires <em>O(facts)</em> space too.</p><p>The implementation of this propagation is <code>computeOwnership</code> in </p><div file="glean/rts/ownership.cpp"></div>.<p></p><p>Ownership propagation happens after all the facts are written, but
before derivation starts. This is why we have the <code>glean complete</code>
command: it marks the predicates complete and computes ownership sets
for the written facts.</p><p>In the future we could consider</p><ul><li>Starting the propagation in parallel with fact writing. We may have to visit facts multiple times, however.</li><li>Do it with less than <em>O(facts)</em> space, to support large DBs. We&#x27;ll probably have to write intermediate results to the DB.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="storing-ownership-in-the-db">Storing ownership in the DB<a class="hash-link" href="#storing-ownership-in-the-db" title="Direct link to heading">â€‹</a></h2><p>Ownership that we store in the DB consists of:</p><ul><li><code>ownershipUnits</code>: a mappings from unit to <code>UnitId</code></li><li><code>ownershipUnitIds</code>: a mapping from <code>UnitId</code> to unit. This is
used only for introspection (displaying an ownership set, e.g. for
the <code>:owner</code> command in the shell).</li><li><code>ownershipSets</code>: a mapping from <code>UsetId</code> to set, encoded using Elias Fano Coding.</li><li><code>factOwners</code>: a mapping from <code>Id</code> to <code>UsetId</code>, giving the owner for
each fact ID. This is an interval map, so for a series of consecutive
fact Ids with the same owner, we only store the first.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="caching-fact-ownership">Caching fact ownership<a class="hash-link" href="#caching-fact-ownership" title="Direct link to heading">â€‹</a></h3><p>Reading from <code>factOwners</code> each time we want the ownership of a fact
can be very expensive, because we need to check the owner
every time we visit a fact during a query to determine its visibility.</p><p>We therefore cache the ownership information in memory. This is done
lazily: we read a page of fact owners at a time. To find the owner of
a fact, we binary-search in the page to find the beginning of the
interval containing the desired fact ID.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ownership-for-derived-facts">Ownership for derived facts<a class="hash-link" href="#ownership-for-derived-facts" title="Direct link to heading">â€‹</a></h2><blockquote><p>A derived fact should be visible if and only if all the facts that
it was derived from are visible.</p></blockquote><p>This naturally gives rise to the following implementation:</p><ul><li>The owner for a fact derived from facts <code>F1...Fn</code> with owners <code>O1...On</code>
respectively is <code>O1 &amp;&amp; ... &amp;&amp; On</code></li></ul><p>This is straightforward except that we might have multiple threads
deriving in parallel, and e want to avoid having duplicate ownership
sets created.</p><p>So the implementation is similar to the way facts are written:</p><ul><li><p>When deriving we create a batch of ownership information
(<code>DefineOwnership</code>) consisting of the new ownership sets and the
mapping from facts to ownership sets. Each <code>DefineOwnership</code> is
written to the DB as it is created, using <code>addDefineOwnership</code>.</p></li><li><p>When writing the facts to the DB, we de-duplicate the ownership sets
against those in the DB, and renumber the sets as necessary. This is
<code>computeDerivedOwnership</code>.</p></li></ul><p>Note that because derivation needs to know the owners of facts derived
from, the ownership propagation described above needs to be complete
first.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ownership-for-stacked-databases">Ownership for stacked databases<a class="hash-link" href="#ownership-for-stacked-databases" title="Direct link to heading">â€‹</a></h2><p>The main complication with stacked DBs is that a DB may induce new
ownership for facts in a lower DB in the stack, as described <a href="#stacked-incremental-dbs">above</a>.</p><p>For the stacked DB we do <a href="#propagating-ownership-to-dependent-facts">ownership
propagation</a> as before,
including propagating ownership to facts in the base DBs. But we don&#x27;t
want to have to consider all facts in the stack, so instead of walking
through all facts in the stack we switch to using a priority queue for
facts in the base DB(s) to track facts to which we are propagating
ownership.</p><p>Now that a fact in the base DB can have multiple owners, we have an
implementation choice:</p><ol><li><p><code>getOwner(fact)</code> returns <em>all</em> owners for the fact.</p><ul><li>A fact is visible if <em>any</em> of its owners is in the slice.</li><li>When deriving facts later, we have to construct the set of the
disjunction of all owners for a fact we derived from.</li></ul></li><li><p><code>getOwner(fact)</code> returns the <em>first</em> owner in the stack. For this
to work, the first owner has to include the base DB owner too. For
example, if fact F has base owner A and new owner B propagated from
the stacked DB, then its owner in the stacked DB should be <code>A ||
B</code>. Now when deriving, we only have one owner for each fact and we
don&#x27;t need to construct new sets.</p></li></ol><p>In Glean we currently do (2) because it seemed simpler.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="derived-facts-in-stacked-incremental-dbs">Derived facts in stacked incremental DBs<a class="hash-link" href="#derived-facts-in-stacked-incremental-dbs" title="Direct link to heading">â€‹</a></h3><p>There is a problem here: suppose we have a fact F with owner A in the
base DB, and we propagate a new owner B to F in a stacked DB. F&#x27;s
owner is now <code>A || B</code>. However, facts that derived from F in the
original base DB will have ownership sets that don&#x27;t include B.  The
consequence is that later we might have a situation where F is
visible, but facts derived from it are not.</p><p>To fix this, we want to do incremental derivation on the stacked DB,
and propagate this new ownership to the base DB, which will fix up the
ownership of the derived facts. Incremental derivation must therefore
consider facts that have new ownership in the stacked DB when
deriving. At the time of writing, this isn&#x27;t implemented yet.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebookincubator/Glean/tree/main/glean/website/docs/implementation/incrementality.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/indexer/scip-dotnet/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Dotnet</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#units" class="table-of-contents__link toc-highlight">Units</a></li><li><a href="#capturing-ownership-data-from-the-indexer" class="table-of-contents__link toc-highlight">Capturing ownership data from the indexer</a><ul><li><a href="#json" class="table-of-contents__link toc-highlight">JSON</a></li><li><a href="#binary" class="table-of-contents__link toc-highlight">Binary</a></li><li><a href="#storing-the-ownership-data" class="table-of-contents__link toc-highlight">Storing the ownership data</a></li></ul></li><li><a href="#ownership-sets" class="table-of-contents__link toc-highlight">Ownership sets</a></li><li><a href="#visibility-and-slices" class="table-of-contents__link toc-highlight">Visibility and slices</a></li><li><a href="#propagating-ownership-to-dependent-facts" class="table-of-contents__link toc-highlight">Propagating ownership to dependent facts</a></li><li><a href="#storing-ownership-in-the-db" class="table-of-contents__link toc-highlight">Storing ownership in the DB</a><ul><li><a href="#caching-fact-ownership" class="table-of-contents__link toc-highlight">Caching fact ownership</a></li></ul></li><li><a href="#ownership-for-derived-facts" class="table-of-contents__link toc-highlight">Ownership for derived facts</a></li><li><a href="#ownership-for-stacked-databases" class="table-of-contents__link toc-highlight">Ownership for stacked databases</a><ul><li><a href="#derived-facts-in-stacked-incremental-dbs" class="table-of-contents__link toc-highlight">Derived facts in stacked incremental DBs</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/glean" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2023 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2d7eea37.js"></script>
<script src="/assets/js/main.0f46e81b.js"></script>
</body>
</html>