"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7733],{15680:(e,n,t)=>{t.r(n),t.d(n,{MDXContext:()=>s,MDXProvider:()=>p,mdx:()=>b,useMDXComponents:()=>c,withMDXComponents:()=>u});var i=t(96540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(){return l=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},l.apply(this,arguments)}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function d(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},l=Object.keys(e);for(i=0;i<l.length;i++)t=l[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(i=0;i<l.length;i++)t=l[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=i.createContext({}),u=function(e){return function(n){var t=c(n.components);return i.createElement(e,l({},n,{components:t}))}},c=function(e){var n=i.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},p=function(e){var n=c(e.components);return i.createElement(s.Provider,{value:n},e.children)},m="mdxType",f={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},h=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,s=d(e,["components","mdxType","originalType","parentName"]),u=c(t),p=r,m=u["".concat(o,".").concat(p)]||u[p]||f[p]||l;return t?i.createElement(m,a(a({ref:n},s),{},{components:t})):i.createElement(m,a({ref:n},s))}));function b(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,o=new Array(l);o[0]=h;var a={};for(var d in n)hasOwnProperty.call(n,d)&&(a[d]=n[d]);a.originalType=e,a[m]="string"==typeof e?e:r,o[1]=a;for(var s=2;s<l;s++)o[s]=t[s];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}h.displayName="MDXCreateElement"},67555:(e,n,t)=>{t.d(n,{D4:()=>o,Lw:()=>a,gD:()=>d});var i=t(96540),r=t(14423);let l;function o(e){return i.createElement("a",{href:l+e.file},e.file)}function a(e){return i.createElement("a",{href:l+e.file},e.children)}l=(0,r.isInternal)()?"https://www.internalfb.com/code/fbsource/fbcode/":"https://github.com/facebookincubator/Glean/tree/master/";const d=e=>{let{children:n,internal:t,external:l}=e;return(0,r.fbContent)({internal:i.createElement("code",null,t),external:i.createElement("code",null,l)})}},15272:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>a,default:()=>m,frontMatter:()=>o,metadata:()=>d,toc:()=>u});var i=t(58168),r=(t(96540),t(15680)),l=(t(14423),t(67555));const o={id:"building",title:"Building Glean from Source",sidebar_label:"Building Glean"},a=void 0,d={unversionedId:"building",id:"building",title:"Building Glean from Source",description:"Introduction",source:"@site/docs/building.md",sourceDirName:".",slug:"/building",permalink:"/docs/building",draft:!1,editUrl:"https://github.com/facebookincubator/Glean/tree/main/glean/website/docs/building.md",tags:[],version:"current",frontMatter:{id:"building",title:"Building Glean from Source",sidebar_label:"Building Glean"},sidebar:"someSidebar",previous:{title:"Introduction",permalink:"/docs/introduction"},next:{title:"Setting up the LSP server",permalink:"/docs/lsp"}},s={},u=[{value:"Introduction",id:"introduction",level:2},{value:"You will need",id:"you-will-need",level:2},{value:"Ubuntu",id:"ubuntu",level:3},{value:"Debian",id:"debian",level:3},{value:"Fedora",id:"fedora",level:3},{value:"Build using Cabal",id:"build-using-cabal",level:2},{value:"Building from the repository",id:"building-from-the-repository",level:2},{value:"Build hsthrift and dependencies",id:"build-hsthrift-and-dependencies",level:3},{value:"Build Glean",id:"build-glean",level:3},{value:"Tips for faster builds",id:"tips-for-faster-builds",level:3}],c={toc:u},p="wrapper";function m(e){let{components:n,...t}=e;return(0,r.mdx)(p,(0,i.A)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,r.mdx)("h2",{id:"introduction"},"Introduction"),(0,r.mdx)("p",null,"First we'll need to install some dependencies, and then we can build\nGlean. You can either build the latest stable release (easiest), or\nbuild the current code from the repository (harder), both methods are\nexplained below."),(0,r.mdx)("h2",{id:"you-will-need"},"You will need"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"Linux. The build is only tested on Linux so far; we hope to add\nsupport for other OSs in the future. We build on x86","_","64 and arm64v8.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"A working Haskell build environment including\n",(0,r.mdx)("a",{parentName:"p",href:"https://www.haskell.org/ghc/"},"GHC")," and Cabal. To see which versions\nGlean is tested with, check the current\n",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/facebookincubator/Glean/blob/master/.github/workflows/ci.yml"},"ci.yml"),"\nscript."))),(0,r.mdx)("p",null,"We recommend installing GHC and Cabal using ",(0,r.mdx)("a",{parentName:"p",href:"https://www.haskell.org/ghcup/"},"ghcup"),":"),(0,r.mdx)("ol",null,(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("a",{parentName:"li",href:"https://www.haskell.org/ghcup/"},"Install ghcup")),(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("inlineCode",{parentName:"li"},"ghcup install ghc 9.6.7")),(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("inlineCode",{parentName:"li"},"ghcup install cabal"))),(0,r.mdx)("p",null,"Additional per-distribution setup follows."),(0,r.mdx)("h3",{id:"ubuntu"},"Ubuntu"),(0,r.mdx)("p",null,"Our CI runs on Ubuntu, so this is the most well-tested platform. If\nyou encounter problems, the source of truth for what works is the\n",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/facebookincubator/Glean/blob/main/.github/workflows/ci.yml"},"github CI workflow"),". In\nthere you can also find the version of Ubuntu we test on; older\nversions may or may not work, in particular using a different version\nof ",(0,r.mdx)("inlineCode",{parentName:"p"},"librocksdb-dev")," is likely to run into problems."),(0,r.mdx)("p",null,"Install these prerequisite packages:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"sudo apt-get install \\\n    g++ \\\n    cmake \\\n    make \\\n    ninja-build \\\n    bison \\\n    flex \\\n    git \\\n    curl \\\n    rsync \\\n    m4 \\\n    pkg-config \\\n    binutils-dev \\\n    libboost-all-dev \\\n    libdouble-conversion-dev \\\n    libdwarf-dev \\\n    libevent-dev \\\n    libfast-float-dev \\\n    libfftw3-dev \\\n    libfmt-dev \\\n    libgflags-dev \\\n    libgmock-dev \\\n    libgoogle-glog-dev \\\n    libgtest-dev \\\n    libiberty-dev \\\n    libjemalloc-dev \\\n    liblz4-dev \\\n    liblzma-dev \\\n    libpcre3-dev \\\n    librocksdb-dev \\\n    libsnappy-dev \\\n    libsodium-dev \\\n    libssl-dev \\\n    libtinfo-dev \\\n    libunwind-dev \\\n    libxxhash-dev \\\n    libzstd-dev \\\n    zlib1g-dev\n")),(0,r.mdx)("p",null,"Additionally if you want to build the C++ indexer:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"apt install clang-15 libclang-15-dev libclang-cpp15-dev libre2-dev\n")),(0,r.mdx)("h3",{id:"debian"},"Debian"),(0,r.mdx)("p",null,"The package dependencies for Debian current are the same as above for Ubuntu."),(0,r.mdx)("h3",{id:"fedora"},"Fedora"),(0,r.mdx)("p",null,"Install prerequisite packages:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"sudo dnf install \\\n    g++ \\\n    make \\\n    cmake \\\n    curl git \\\n    rsync m4 \\\n    ninja-build \\\n    binutils \\\n    bison flex \\\n    libzstd-devel \\\n    boost-devel \\\n    libevent-devel \\\n    double-conversion-devel \\\n    glog-devel \\\n    gflags-devel \\\n    zlib-devel \\\n    openssl-devel \\\n    libunwind-devel \\\n    libsodium-devel \\\n    pcre-devel \\\n    fftw-devel \\\n    xxhash-devel \\\n    snappy-devel \\\n    lz4-devel \\\n    gtest-devel \\\n    fmt-devel \\\n    xxhash \\\n    clang \\\n    llvm12-devel \\\n    libfast-float-dev\n")),(0,r.mdx)("h2",{id:"build-using-cabal"},"Build using Cabal"),(0,r.mdx)("p",null,"To build and install the latest stable version of Glean:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"cabal install glean\n")),(0,r.mdx)("p",null,"This will install the following executables in ",(0,r.mdx)("inlineCode",{parentName:"p"},"~/.cabal/bin"),":"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"glean"),": the ",(0,r.mdx)("a",{parentName:"li",href:"/docs/cli"},"command-line tool")," for doing most things"),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"glean-server"),": to run a ",(0,r.mdx)("a",{parentName:"li",href:"/docs/server"},"server")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"glass-server"),": the ",(0,r.mdx)("a",{parentName:"li",href:"https://github.com/facebookincubator/Glean/tree/main/glean/glass"},"Glass")," symbol server")),(0,r.mdx)("p",null,"The schema source files will be installed somewhere under\n",(0,r.mdx)("inlineCode",{parentName:"p"},"~/.cabal/store")," (Glean knows where to find them)."),(0,r.mdx)("p",null,"Installing with ",(0,r.mdx)("inlineCode",{parentName:"p"},"cabal install")," is sufficient if you want to:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"Just try it out, e.g. with the generic LSP server."),(0,r.mdx)("li",{parentName:"ul"},"Index some source code in a supported language"),(0,r.mdx)("li",{parentName:"ul"},"Run queries against a DB, perhaps produced by someone else"),(0,r.mdx)("li",{parentName:"ul"},"Run a server (including Glass)"),(0,r.mdx)("li",{parentName:"ul"},"Build something that depends on Glean")),(0,r.mdx)("p",null,"If you want to make changes to the schema or work on Glean itself then\nyou will likely need to build from source: continue to the next\nsection."),(0,r.mdx)("p",null,"If you want to use the ",(0,r.mdx)(l.Lw,{file:"glean/lsp",mdxType:"SrcFileLink"},"generic LSP\nserver"),", build and install it with:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"cabal install glean-lsp\n")),(0,r.mdx)("h2",{id:"building-from-the-repository"},"Building from the repository"),(0,r.mdx)("p",null,"Clone the repository:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"git clone https://github.com/facebookincubator/Glean.git\ncd Glean\n")),(0,r.mdx)("h3",{id:"build-hsthrift-and-dependencies"},"Build hsthrift and dependencies"),(0,r.mdx)("p",null,"Glean depends on hsthrift, folly, rocksdb and some other core libraries.\nWe need to set paths to these that the Glean build can find the thrift compiler\nand associated libraries:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"export LD_LIBRARY_PATH=$HOME/.hsthrift/lib:$HOME/.hsthrift/lib64:$LD_LIBRARY_PATH\nexport PKG_CONFIG_PATH=$HOME/.hsthrift/lib/pkgconfig:$HOME/.hsthrift/lib64/pkgconfig\nexport PATH=$PATH:$HOME/.hsthrift/bin\n")),(0,r.mdx)("p",null,"On Fedora/CentOS and possibly other non-Debian systems, you also need to set:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"export LIBRARY_PATH=$HOME/.hsthrift/lib:$HOME/.hsthrift/lib64:$LIBRARY_PATH\n")),(0,r.mdx)("p",null,"These will build with either gcc or clang as the base C and C++ compilers. Clang is\nthe best supported C++ compiler for this project."),(0,r.mdx)("p",null,"Now we will clone ",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/facebookincubator/hsthrift"},"hsthrift")," and\nbuild and install its dependencies:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"./install_deps.sh\n")),(0,r.mdx)("h3",{id:"build-glean"},"Build Glean"),(0,r.mdx)("p",null,"Now you can build all the Glean parts:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"cabal update\nmake\n")),(0,r.mdx)("p",null,"If everything worked, the tests should pass:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"make test\n")),(0,r.mdx)("p",null,"At this point you can ",(0,r.mdx)("inlineCode",{parentName:"p"},"cabal install")," to install the executables into\n",(0,r.mdx)("inlineCode",{parentName:"p"},"~/.cabal/bin"),"."),(0,r.mdx)("h3",{id:"tips-for-faster-builds"},"Tips for faster builds"),(0,r.mdx)("p",null,"If you have 4 or more cores and at least 16G of ram, you can significantly speed up the build times by passing some flags to the build stages.\nOn an 6 core machine with 16G of ram you might use, to save 50% or more of the build time."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"./install_deps.sh --threads 6\nmake EXTRA_GHC_OPTS='-j4 +RTS -A128m -n2m -RTS'\n")),(0,r.mdx)("p",null,"Using clang++-12 and clang-12 as the C and C++ compilers can shave another 25% off the build time."))}m.isMDXComponent=!0},80510:function(e,n,t){var i=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(r,l){function o(e){try{d(i.next(e))}catch(n){l(n)}}function a(e){try{d(i.throw(e))}catch(n){l(n)}}function d(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(o,a)}d((i=i.apply(e,n||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0}),n.getSpecInfo=void 0;const r=t(88266);n.getSpecInfo=function(e){return i(this,void 0,void 0,(function*(){return yield r.call({module:"bloks",api:"getSpecInfo",args:{styleId:e}})}))}},88266:function(e,n){var t=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(r,l){function o(e){try{d(i.next(e))}catch(n){l(n)}}function a(e){try{d(i.throw(e))}catch(n){l(n)}}function d(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(o,a)}d((i=i.apply(e,n||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0}),n.call=void 0;let i=!1,r=0;const l={};n.call=function(e){return t(this,void 0,void 0,(function*(){if("staticdocs.thefacebook.com"!==window.location.hostname&&"localhost"!==window.location.hostname)return Promise.reject(new Error("Not running on static docs"));i||(i=!0,window.addEventListener("message",(e=>{if("static-docs-bridge-response"!==e.data.event)return;const n=e.data.id;n in l||console.error(`Recieved response for id: ${n} with no matching receiver`),"response"in e.data?l[n].resolve(e.data.response):l[n].reject(new Error(e.data.error)),delete l[n]})));const n=r++,t=new Promise(((e,t)=>{l[n]={resolve:e,reject:t}})),o={event:"static-docs-bridge-call",id:n,module:e.module,api:e.api,args:e.args},a="localhost"===window.location.hostname?"*":"https://www.internalfb.com";return window.parent.postMessage(o,a),t}))}},70680:function(e,n,t){var i=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(r,l){function o(e){try{d(i.next(e))}catch(n){l(n)}}function a(e){try{d(i.throw(e))}catch(n){l(n)}}function d(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(o,a)}d((i=i.apply(e,n||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0}),n.reportFeatureUsage=n.reportContentCopied=void 0;const r=t(88266);n.reportContentCopied=function(e){return i(this,void 0,void 0,(function*(){const{textContent:n}=e;try{yield r.call({module:"feedback",api:"reportContentCopied",args:{textContent:n}})}catch(t){}}))},n.reportFeatureUsage=function(e){return i(this,void 0,void 0,(function*(){const{featureName:n,id:t}=e;console.log("used feature");try{yield r.call({module:"feedback",api:"reportFeatureUsage",args:{featureName:n,id:t}})}catch(i){}}))}},14423:function(e,n,t){var i=this&&this.__createBinding||(Object.create?function(e,n,t,i){void 0===i&&(i=t),Object.defineProperty(e,i,{enumerable:!0,get:function(){return n[t]}})}:function(e,n,t,i){void 0===i&&(i=t),e[i]=n[t]}),r=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),l=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&i(n,e,t);return r(n,e),n};Object.defineProperty(n,"__esModule",{value:!0}),n.OssOnly=n.FbInternalOnly=n.getEphemeralDiffNumber=n.hasEphemeralDiffNumber=n.isInternal=n.validateFbContentArgs=n.fbInternalOnly=n.fbContent=n.inpageeditor=n.feedback=n.uidocs=n.bloks=void 0,n.bloks=l(t(80510)),n.uidocs=l(t(3730)),n.feedback=l(t(70680)),n.inpageeditor=l(t(45458));const o=["internal","external"];function a(e){return s(e),u()?"internal"in e?d(e.internal):[]:"external"in e?d(e.external):[]}function d(e){return"function"==typeof e?e():e}function s(e){if("object"!=typeof e)throw new Error(`fbContent() args must be an object containing keys: ${o}. Instead got ${e}`);if(!Object.keys(e).find((e=>o.find((n=>n===e)))))throw new Error(`No valid args found in ${JSON.stringify(e)}. Accepted keys: ${o}`);const n=Object.keys(e).filter((e=>!o.find((n=>n===e))));if(n.length>0)throw new Error(`Unexpected keys ${n} found in fbContent() args. Accepted keys: ${o}`)}function u(){try{return Boolean(!1)}catch(e){return console.log("process.env.FB_INTERNAL couldn't be read, maybe you forgot to add the required webpack EnvironmentPlugin config?",e),!1}}function c(){try{return null}catch(e){return console.log("process.env.PHABRICATOR_DIFF_NUMBER couldn't be read, maybe you forgot to add the required webpack EnvironmentPlugin config?",e),null}}n.fbContent=a,n.fbInternalOnly=function(e){return a({internal:e})},n.validateFbContentArgs=s,n.isInternal=u,n.hasEphemeralDiffNumber=function(){return Boolean(c())},n.getEphemeralDiffNumber=c,n.FbInternalOnly=function(e){return u()?e.children:null},n.OssOnly=function(e){return u()?null:e.children}},45458:function(e,n,t){var i=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(r,l){function o(e){try{d(i.next(e))}catch(n){l(n)}}function a(e){try{d(i.throw(e))}catch(n){l(n)}}function d(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(o,a)}d((i=i.apply(e,n||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0}),n.submitDiff=void 0;const r=t(88266);n.submitDiff=function(e){return i(this,void 0,void 0,(function*(){const{file_path:n,new_content:t,project_name:i,diff_number:l}=e;try{return yield r.call({module:"inpageeditor",api:"createPhabricatorDiffApi",args:{file_path:n,new_content:t,project_name:i,diff_number:l}})}catch(o){throw new Error(`Error occurred while trying to submit diff. Stack trace: ${o}`)}}))}},3730:function(e,n,t){var i=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(r,l){function o(e){try{d(i.next(e))}catch(n){l(n)}}function a(e){try{d(i.throw(e))}catch(n){l(n)}}function d(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(o,a)}d((i=i.apply(e,n||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0}),n.getApi=n.docsets=void 0;const r=t(88266);n.docsets={BLOKS_CORE:"887372105406659"},n.getApi=function(e){return i(this,void 0,void 0,(function*(){const{name:n,framework:t,docset:i}=e;return yield r.call({module:"uidocs",api:"getApi",args:{name:n,framework:t,docset:i}})}))}}}]);