"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2184],{15680:(e,t,n)=>{n.r(t),n.d(t,{MDXContext:()=>c,MDXProvider:()=>m,mdx:()=>b,useMDXComponents:()=>u,withMDXComponents:()=>d});var a=n(96540);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},o.apply(this,arguments)}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),d=function(e){return function(t){var n=u(t.components);return a.createElement(e,o({},t,{components:n}))}},u=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},m=function(e){var t=u(e.components);return a.createElement(c.Provider,{value:t},e.children)},p="mdxType",f={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=u(n),m=r,p=d["".concat(i,".").concat(m)]||d[m]||f[m]||o;return n?a.createElement(p,s(s({ref:t},c),{},{components:n})):a.createElement(p,s({ref:t},c))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},8572:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var a=n(58168),r=(n(96540),n(15680)),o=n(14423);const i={id:"databases",title:"Glean Databases",sidebar_label:"Glean Databases"},s=void 0,l={unversionedId:"databases",id:"databases",title:"Glean Databases",description:"Glean stores facts in databases.",source:"@site/docs/databases.md",sourceDirName:".",slug:"/databases",permalink:"/docs/databases",draft:!1,editUrl:"https://github.com/facebookincubator/Glean/tree/main/glean/website/docs/databases.md",tags:[],version:"current",frontMatter:{id:"databases",title:"Glean Databases",sidebar_label:"Glean Databases"},sidebar:"someSidebar",previous:{title:"Derived Predicates",permalink:"/docs/derived"},next:{title:"Writing data to Glean",permalink:"/docs/write"}},c={},d=[{value:"Working with local databases",id:"working-with-local-databases",level:2},{value:"Lifecycle of a database",id:"lifecycle-of-a-database",level:2}],u=(m="Lifecycle",function(e){return console.warn("Component "+m+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.mdx)("div",e)});var m;const p={toc:d},f="wrapper";function h(e){let{components:t,...n}=e;return(0,r.mdx)(f,(0,a.A)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.mdx)("p",null,"Glean stores facts in databases."),(0,r.mdx)("p",null,"A Glean database has:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"A ",(0,r.mdx)("strong",{parentName:"li"},"name"),'. This is often (but not always) the name of the source code repository from which the facts in the database were collected. Indeed, for historical reasons we sometimes say "repository" or "repo" when we mean "database".'),(0,r.mdx)("li",{parentName:"ul"},"A ",(0,r.mdx)("strong",{parentName:"li"},"hash"),". This is just an arbitrary string, used to distinguish different versions of databases with the same name. For source code repositories it can be the revision of the repository that was indexed."),(0,r.mdx)("li",{parentName:"ul"},"Some ",(0,r.mdx)("strong",{parentName:"li"},"properties"),". A database has a set of key-value pairs associated with it. Some of these are created by Glean itself, and others can be set by a client when the DB is created, or while writing facts. Properties can be used to store arbitrary metadata about the DB, and can be accessed cheaply."),(0,r.mdx)("li",{parentName:"ul"},"A ",(0,r.mdx)("strong",{parentName:"li"},"schema"),". The schema is stored in the DB, so that a DB knows the structure of the data it stores. You can query the DB using any schema that is ",(0,r.mdx)("a",{parentName:"li",href:"/docs/schema/changing#compatibility"},"compatible")," with the DB's schema.")),(0,r.mdx)(o.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,r.mdx)("p",null,"At Facebook, we have adopted an informal convention for database names: ",(0,r.mdx)("inlineCode",{parentName:"p"},"<repo>.<use-case>"),". For example, test coverage data for the ",(0,r.mdx)("inlineCode",{parentName:"p"},"www")," repo uses the database name ",(0,r.mdx)("inlineCode",{parentName:"p"},"www.tcc"),". We sometimes omit the use case if the database is for primary source code indexing of the repo, so for example the index of Hack code in ",(0,r.mdx)("inlineCode",{parentName:"p"},"www"),' is called just "',(0,r.mdx)("inlineCode",{parentName:"p"},"www"),'".')),(0,r.mdx)("p",null,"The name and hash together uniquely identify a database. This is written ",(0,r.mdx)("inlineCode",{parentName:"p"},"<name>/<hash>"),", and it is how you refer to a database in most cases when working with Glean. For example, in the shell's ",(0,r.mdx)("inlineCode",{parentName:"p"},":db")," command, or the ",(0,r.mdx)("inlineCode",{parentName:"p"},"--db")," argument to the command-line tools."),(0,r.mdx)("h2",{id:"working-with-local-databases"},"Working with local databases"),(0,r.mdx)("p",null,"Most Glean tools (in particular the ",(0,r.mdx)("a",{parentName:"p",href:"/docs/shell"},"shell")," and the ",(0,r.mdx)("a",{parentName:"p",href:"/docs/cli"},"CLI\ntool"),") can work either by talking to a ",(0,r.mdx)("a",{parentName:"p",href:"/docs/server"},"Glean server")," or\naccessing databases on the local filesystem directly. The access\nmethod is chosen by these command-line flags:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"--service <tier>")," or ",(0,r.mdx)("inlineCode",{parentName:"li"},"--service <host>:<port>"),"  Connect to a remote Glean server."),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"--db-root <dir>"),"  Use databases stored locally in the directory ",(0,r.mdx)("inlineCode",{parentName:"li"},"<dir>")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"--db-tmp")," Create a temporary directory to store DBs and delete it\nwhen the program exits."),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"--db-memory")," Store databases in memory rather than on disk.")),(0,r.mdx)("p",null,"These flags are accepted by all the Glean command-line tools,\nincluding ",(0,r.mdx)("inlineCode",{parentName:"p"},"glean")," and ",(0,r.mdx)("inlineCode",{parentName:"p"},"glean-server"),"."),(0,r.mdx)(o.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,r.mdx)("p",null,"The default for all commands is ",(0,r.mdx)("inlineCode",{parentName:"p"},"--service glean.query.prod"),", so all requests go to the production Glean query service.")),(0,r.mdx)("p",null,"To use the ",(0,r.mdx)("a",{parentName:"p",href:"/docs/shell"},"shell")," with local databases, you can do:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-lang=sh"},"mkdir /tmp/glean\nglean shell --db-root /tmp/glean\n")),(0,r.mdx)("p",null,"To run a server, see ",(0,r.mdx)("a",{parentName:"p",href:"/docs/server"},"Running the Glean Server"),"."),(0,r.mdx)("h2",{id:"lifecycle-of-a-database"},"Lifecycle of a database"),(0,r.mdx)("p",null,"A database will typically be created by an automatic periodic job to\nindex the current state of a source repository.  The process works\nlike this:"),(0,r.mdx)(u,{mdxType:"Lifecycle"}),(0,r.mdx)(o.OssOnly,{mdxType:"OssOnly"},(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"The job invokes ",(0,r.mdx)("inlineCode",{parentName:"p"},"glean create --service <write-server> <args>")," to create the database.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"At this point the database is in the ",(0,r.mdx)("strong",{parentName:"p"},"Incomplete")," state. Queries\nare supported in this state, and always reflect the current contents.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"Facts are written to the database using the methods described in ",(0,r.mdx)("a",{parentName:"p",href:"/docs/write"},"Writing data to Glean"),", and finally the database is closed by invoking ",(0,r.mdx)("inlineCode",{parentName:"p"},"glean finish --service <write-server> <args>")," or the appropriate Thrift method.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"The database is now in the ",(0,r.mdx)("strong",{parentName:"p"},"Complete")," state.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"If backups are allowed for this database, then:"),(0,r.mdx)("ul",{parentName:"li"},(0,r.mdx)("li",{parentName:"ul"},"the write server uploads the database to backup storage."),(0,r.mdx)("li",{parentName:"ul"},"servers that are configured to restore databases automatically can download the DB from backup storage, and use it to serve queries from clients.")))),(0,r.mdx)("admonition",{type:"note"},(0,r.mdx)("p",{parentName:"admonition"},"There are currently no backup backends implemented for open-source Glean."))))}h.isMDXComponent=!0},80510:function(e,t,n){var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(r,o){function i(e){try{l(a.next(e))}catch(t){o(t)}}function s(e){try{l(a.throw(e))}catch(t){o(t)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getSpecInfo=void 0;const r=n(88266);t.getSpecInfo=function(e){return a(this,void 0,void 0,(function*(){return yield r.call({module:"bloks",api:"getSpecInfo",args:{styleId:e}})}))}},88266:function(e,t){var n=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(r,o){function i(e){try{l(a.next(e))}catch(t){o(t)}}function s(e){try{l(a.throw(e))}catch(t){o(t)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.call=void 0;let a=!1,r=0;const o={};t.call=function(e){return n(this,void 0,void 0,(function*(){if("staticdocs.thefacebook.com"!==window.location.hostname&&"localhost"!==window.location.hostname)return Promise.reject(new Error("Not running on static docs"));a||(a=!0,window.addEventListener("message",(e=>{if("static-docs-bridge-response"!==e.data.event)return;const t=e.data.id;t in o||console.error(`Recieved response for id: ${t} with no matching receiver`),"response"in e.data?o[t].resolve(e.data.response):o[t].reject(new Error(e.data.error)),delete o[t]})));const t=r++,n=new Promise(((e,n)=>{o[t]={resolve:e,reject:n}})),i={event:"static-docs-bridge-call",id:t,module:e.module,api:e.api,args:e.args},s="localhost"===window.location.hostname?"*":"https://www.internalfb.com";return window.parent.postMessage(i,s),n}))}},70680:function(e,t,n){var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(r,o){function i(e){try{l(a.next(e))}catch(t){o(t)}}function s(e){try{l(a.throw(e))}catch(t){o(t)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.reportFeatureUsage=t.reportContentCopied=void 0;const r=n(88266);t.reportContentCopied=function(e){return a(this,void 0,void 0,(function*(){const{textContent:t}=e;try{yield r.call({module:"feedback",api:"reportContentCopied",args:{textContent:t}})}catch(n){}}))},t.reportFeatureUsage=function(e){return a(this,void 0,void 0,(function*(){const{featureName:t,id:n}=e;console.log("used feature");try{yield r.call({module:"feedback",api:"reportFeatureUsage",args:{featureName:t,id:n}})}catch(a){}}))}},14423:function(e,t,n){var a=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,a){void 0===a&&(a=n),e[a]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&a(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.OssOnly=t.FbInternalOnly=t.getEphemeralDiffNumber=t.hasEphemeralDiffNumber=t.isInternal=t.validateFbContentArgs=t.fbInternalOnly=t.fbContent=t.inpageeditor=t.feedback=t.uidocs=t.bloks=void 0,t.bloks=o(n(80510)),t.uidocs=o(n(3730)),t.feedback=o(n(70680)),t.inpageeditor=o(n(45458));const i=["internal","external"];function s(e){return c(e),d()?"internal"in e?l(e.internal):[]:"external"in e?l(e.external):[]}function l(e){return"function"==typeof e?e():e}function c(e){if("object"!=typeof e)throw new Error(`fbContent() args must be an object containing keys: ${i}. Instead got ${e}`);if(!Object.keys(e).find((e=>i.find((t=>t===e)))))throw new Error(`No valid args found in ${JSON.stringify(e)}. Accepted keys: ${i}`);const t=Object.keys(e).filter((e=>!i.find((t=>t===e))));if(t.length>0)throw new Error(`Unexpected keys ${t} found in fbContent() args. Accepted keys: ${i}`)}function d(){try{return Boolean(!1)}catch(e){return console.log("process.env.FB_INTERNAL couldn't be read, maybe you forgot to add the required webpack EnvironmentPlugin config?",e),!1}}function u(){try{return null}catch(e){return console.log("process.env.PHABRICATOR_DIFF_NUMBER couldn't be read, maybe you forgot to add the required webpack EnvironmentPlugin config?",e),null}}t.fbContent=s,t.fbInternalOnly=function(e){return s({internal:e})},t.validateFbContentArgs=c,t.isInternal=d,t.hasEphemeralDiffNumber=function(){return Boolean(u())},t.getEphemeralDiffNumber=u,t.FbInternalOnly=function(e){return d()?e.children:null},t.OssOnly=function(e){return d()?null:e.children}},45458:function(e,t,n){var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(r,o){function i(e){try{l(a.next(e))}catch(t){o(t)}}function s(e){try{l(a.throw(e))}catch(t){o(t)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.submitDiff=void 0;const r=n(88266);t.submitDiff=function(e){return a(this,void 0,void 0,(function*(){const{file_path:t,new_content:n,project_name:a,diff_number:o}=e;try{return yield r.call({module:"inpageeditor",api:"createPhabricatorDiffApi",args:{file_path:t,new_content:n,project_name:a,diff_number:o}})}catch(i){throw new Error(`Error occurred while trying to submit diff. Stack trace: ${i}`)}}))}},3730:function(e,t,n){var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(r,o){function i(e){try{l(a.next(e))}catch(t){o(t)}}function s(e){try{l(a.throw(e))}catch(t){o(t)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getApi=t.docsets=void 0;const r=n(88266);t.docsets={BLOKS_CORE:"887372105406659"},t.getApi=function(e){return a(this,void 0,void 0,(function*(){const{name:t,framework:n,docset:a}=e;return yield r.call({module:"uidocs",api:"getApi",args:{name:t,framework:n,docset:a}})}))}}}]);